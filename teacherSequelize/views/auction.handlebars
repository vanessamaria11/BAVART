<div class="bodyBackgroundDiv">
</div>
<div class="bodyDiv">
	<div class="container">
		<br>
		<h1>Auction Room</h1>
		<br>
		<h2>Choose an art piece below and place your bid</h2>
		<br>
      <div class="mainlistitem">
      <div class="items">
       <div>
        <div id="timeToExpire"></div>
	        <div id="wellSection">
						{{#each imageArr}}
							<div class="well">
							<span id="picId">{{id}}</span>
							<span id="picName">{{name}}</span> <br>
			        <span id="bidding">$ {{bidprice}}</span>
			        <span id="picBidder"> Highest bidder: {{this.User.userName}}</span>
							<img src="/api/getimage/{{name}}" class="img-responsive"/>
							</div>
						{{/each}}
					</div>	
        <input type="text" name="numPic" placeholder="# of picture" id="pictureNum">
        <input type="text" name="bidAmount" placeholder="enter bid" id="bidPrice">
        <button type="submit" id="submit">Submit</button>
         </div>
            </div> 
            <div class="formdiv">
          </div>
          <br>
         </div>
			<div id="priceLowModal" class="modal fade" role="dialog">
	      <div class="modal-dialog">
	        <!-- Modal content-->
	        <div class="modal-content">
	          <div class="modal-header">
	            <button type="button" class="close" data-dismiss="modal">&times;</button>
	            <h4 class="modal-title">Invalid</h4>
	          </div>
	          <div class="modal-body">
	            <p>Price entered is too low, Please enter another bid!</p>
	          </div>
	          <div class="modal-footer">
	            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	          </div>
	        </div>
	      </div>
	  </div>
	  <div id="bidSuccess" class="modal fade" role="dialog">
	      <div class="modal-dialog">
	        <!-- Modal content-->
	        <div class="modal-content">
	          <div class="modal-header">
	            <button type="button" class="close" data-dismiss="modal">&times;</button>
	            <h4 class="modal-title">Success</h4>
	          </div>
	          <div class="modal-body">
	            <p>You are the highest bidder!</p>
	          </div>
	          <div class="modal-footer">
	            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	          </div>
	        </div>
	      </div>
	  </div>
	  	  <div id="pleaseLog" class="modal fade" role="dialog">
	      <div class="modal-dialog">
	        <!-- Modal content-->
	        <div class="modal-content">
	          <div class="modal-header">
	            <button type="button" class="close" data-dismiss="modal">&times;</button>
	            <h4 class="modal-title">Error</h4>
	          </div>
	          <div class="modal-body">
	            <p>You have to be logged in!</p>
	          </div>
	          <div class="modal-footer">
	            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	          </div>
	        </div>
	      </div>
	  </div>

		<h3>Click <a href="/home">here</a> go back to home</h3>

		<footer id="auctionFooter">
			<div>
				@Copyright Bobby Frazette, Abhaya Pawar, Vanessa Otto, &amp; Adam Zamojski
			</div>
		</footer>
	</div>
	<!-- 
	</body>
	</html> -->

	<script type="text/javascript">
		
	$("#submit").on("click", function(){

	  var currentURL = window.location.origin;

	  var bidPost = {
	  	bidAmount: parseInt($("#bidPrice").val().trim()),
	  	pictureNum: parseInt($("#pictureNum").val().trim()),
	  	getToken: localStorage.getItem("token")
	  }
	  console.log(bidPost.getToken);
	  console.log(bidPost.pictureNum);

	  $.get("/api/checklog" + bidPost.getToken, function(data) {

	  		// console.log(data.login);

	  		if (data == null) {
	  			$("#pleaseLog").modal('toggle');
	  			return;
	  		} 
	  		if (data.login == true) {
	  			postBid();
	  		}
	  		else {
	  			$("#pleaseLog").modal('toggle');
	  			return;
	  		}

	  });
	  function postBid() 
	  {

		  $.get("/api/getprice" + bidPost.pictureNum, function(data) {
		  	var itemPrice = data.bidprice;
		  	console.log(itemPrice);

		  	if (itemPrice >= bidPost.bidAmount) {
		  		$("#priceLowModal").modal('toggle');
		  		return;
		  	}
		  	else if (bidPost.bidAmount > itemPrice) {
		  		
		  		updateBid(bidPost);
		  		// updateBid.reload(bidPost);

		  	}

		  });
		}

	});

	function updateBid(data) {
		var currentURL = window.location.origin;

		// console.log(data.bidAmount);
		$.post(currentURL + "/api/bid", data, function(result) {	

			$("#pictureNum").val("");
			$("#bidPrice").val("");
			$("#bidSuccess").modal('toggle');
			console.log(result);
			console.log(result[0].name);
			console.log(result[0].bidprice);

			getBidItems(result);
			// for (var i = 1; i < result.length; i++) {
			// 	$("#picId").html(result[i].id);
			// 	$("#picName").html(result[i].name);
			// 	$("#bidding").html(result[i].bidprice);
			// 	$("#picBidder").html(result[i].UserId);
			// }
			// window.location.reload();
			// getBidItems();
			// location.reload(true);
		});

	}


		function getBidItems(data) {

			$("#wellSection").empty();

			for (var i = 0; i < data.length; i++) {
				console.log("in the for loop");
				console.log(data[0].image_name);
				var wellSection = $('<div>');
				wellSection.addClass("well");
				wellSection.attr("id", "pictureWell-" + i);
				$("#wellSection").append(wellSection);

				$("#pictureWell-" +i).append("<span>" + data[i].id + "</span>:  ");
				$("#pictureWell-" +i).append("<span>" + data[i].name + "</span> <br>");
				$("#pictureWell-" +i).append("<span>$" + data[i].bidprice + "</span>");
				$("#pictureWell-" +i).append("<img src= '/api/getimage/" + data[i].name + "' class=img-responsive></img>");

			};
		}

	// function reload() {

	// 	$("#bidding").load("auction");
	// }
	//function to set when the bid will end
	function timer() {
		// Set the date we're counting down to
	var countDownDate = new Date("May 15, 2017 00:00:00").getTime();

		// Update the count down every 1 second
		var x = setInterval(function() {

		    // Get todays date and time
		    var now = new Date().getTime();
		    
		    // Find the distance between now an the count down date
		    var distance = countDownDate - now;
		    
		    // Time calculations for days, hours, minutes and seconds
		    var days = Math.floor(distance / (1000 * 60 * 60 * 24));
		    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
		    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
		    var seconds = Math.floor((distance % (1000 * 60)) / 1000);
		    
		    // Output the result in an element with id="demo"
		    $("#timeToExpire").html("Bid Ends: " + days + "d " + hours + "h "
		    + minutes + "m " + seconds + "s ");
		    
		    // If the count down is over, write some text 
		    if (distance < 0) {
		        clearInterval(x);
		        $("#timeToExpire").html("EXPIRED");
		    }
		}, 1000);
	}
	// //initial functions are called to display artwork and bids to page
	// getBidItems();
	timer();



	</script>
</div>